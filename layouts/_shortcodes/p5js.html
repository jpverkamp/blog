{{ $width := mul 1.1 (int (or ($.Get "width") 400)) }}
{{ $height := mul 1.1 (int (or ($.Get "height") 400)) }}
{{ $startPaused := (eq (or ($.Get "startPaused") "false") "true") }}
{{ $id := or ($.Get "id") (substr (.Inner | md5) 0 4) }}
{{ $libraries := $.Get "libraries" }}

{{ $header := `
<html>
<head>
` }}

{{- $scripts := slice 
    "https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.11.10/p5.min.js"
    "https://unpkg.com/p5.gui.variables@1.0.1/libraries/quicksettings.js"
    "https://unpkg.com/p5.gui.variables@1.0.1/libraries/p5.gui.js"
-}}

{{- range $script := $scripts -}}
    {{- $resource := resources.GetRemote $script | minify | fingerprint -}}
    {{ $header = (print $header `<script src="` (absURL $resource.RelPermalink) `"></script>`) }}
{{- end }}   

{{ range $library := (split $libraries " ") }}
    {{- if $library -}}
        {{- $resource := resources.GetRemote $library | minify | fingerprint }}
        {{ $header = (print $header `<script src="` (absURL $resource.RelPermalink) `"></script>`) }}
    {{- end -}}
{{ end }}

{{ $header = (print $header `

    <style>canvas { border: 1px solid black; border-radius: 1em; }</style>
</head>
<body>
`) }}

{{ $footer := `
<noscript>To display this p5.js sketch, JavaScript must be enabled.</noscript>
</body>
</html>
`}}

{{ $additionalScript := `
function setup() {
    // Store a copy of the original params
    const defaultParams = typeof params !== "undefined" ? { ...params } : {};
    window.defaultParams = defaultParams; // Store for use in updateQueryParameters

    if (typeof params !== "undefined") {
        const urlParams = new URLSearchParams(parent.window.location.search);
        let hasQueryParams = false;
        
        for (const key in params) {
            if (urlParams.has(key)) {
                hasQueryParams = true;
                break;
            }
        }

        // Load from query parameters if present
        // Fallback to legacy hash fragment
        if (hasQueryParams) {
            for (const key in params) {
                if (urlParams.has(key)) {
                    const value = urlParams.get(key);
                    // Parse the value based on the type of the default param
                    if (typeof defaultParams[key] === 'boolean') {
                        params[key] = value === 'true';
                    } else if (typeof defaultParams[key] === 'number') {
                        params[key] = parseFloat(value);
                    } else {
                        params[key] = value;
                    }
                }
            }
        } else if (parent.location.hash) {
            try {
                var settings = JSON.parse(atob(parent.location.hash.substring(1)));
                Object.keys(params).forEach((key) => params[key] = key in settings ? settings[key] : params[key]);
            } catch(ex) {
            }
        }
    }

    oldSetup();
    if (START_PAUSED) {
        noLoop();
    }

    createButton("play/pause").mousePressed(() => {
        if (isLooping()) {
            noLoop();
        } else {
            loop();
        }
    });

    createButton("save").mousePressed(() => {
        saveCanvas('photo', 'png')
    });

    createButton("clear").mousePressed(() => {
        if (typeof reset !== 'undefined') {
            reset();
        } else {
            clear();
        }
    });

    createButton("reload").mousePressed(() => {
        window.location.reload();
    });

    /*
    if (typeof params !== "undefined") {
        createButton("default").mousePressed(() => {
            for (const key in defaultParams) {
                params[key] = defaultParams[key];
            }
            parent.location.hash = btoa(JSON.stringify(params));
            window.location.reload();
        });

        createButton("randomize").mousePressed(() => {
            // Grab all inputs inside the GUI container
            const guiContainer = document.querySelector('.qs_main'); 
            if (!guiContainer) return;

            const inputs = guiContainer.querySelectorAll('input');
            let i = 0;

            for (const key in params) {
                const el = inputs[i++];
                if (!el) continue;

                if (el.type === "checkbox") {
                    el.checked = Math.random() < 0.5;
                    params[key] = el.checked;
                } else if (el.type === "range") {
                    const min = parseFloat(el.min);
                    const max = parseFloat(el.max);
                    const step = parseFloat(el.step) || 1;
                    const rangeSteps = Math.floor((max - min) / step);
                    const randomStep = Math.floor(Math.random() * (rangeSteps + 1));
                    const value = min + randomStep * step;
                    el.value = value;
                    params[key] = value;
                } else if (el.tagName.toLowerCase() === "select") {
                    const options = el.options;
                    const randomIndex = Math.floor(Math.random() * options.length);
                    el.selectedIndex = randomIndex;
                    params[key] = options[randomIndex].value;
                } else {
                    console.warn("Unsupported input type for randomization: " + el.type);
                }

                // Trigger input event to update the GUI and callbacks
                el.dispatchEvent(new Event('input', { bubbles: true }));
            }

            // Save the random state to hash
            parent.location.hash = btoa(JSON.stringify(params));
        });
    }
    */

    if (typeof params !== "undefined") {
        for (var el of document.querySelectorAll('input')) {
            if (el.id && el.id.startsWith('qs_')) {
                el.addEventListener('change', () => {
                    updateQueryParameters();
                });
            }
        }
    }
}

function updateQueryParameters() {
    if (typeof params === "undefined") return;
    
    const defaultParams = typeof window.defaultParams !== "undefined" ? window.defaultParams : {};
    const urlParams = new URLSearchParams();
    
    // Only add parameters that differ from the default
    for (const key in params) {
        const value = params[key];
        if (JSON.stringify(value) !== JSON.stringify(defaultParams[key])) {
            urlParams.set(key, value);
        }
    }
    
    // Update URL without saving to history
    const newUrl = urlParams.toString() ? 
        parent.window.location.pathname + '?' + urlParams.toString() :
        parent.window.location.pathname;
    parent.window.history.replaceState({}, '', newUrl);
}
`}}

<div class="tab">
    <button id="iframedemo" class="tablinks default" data-tabset="{{ $id }}" onclick="changeTab(event, '{{ $id }}', 'iframedemo')">Demo</button>
    {{ if (.Scratch.Get "tabs") }}

        {{ range $tab := .Scratch.Get "tabs" }}
            {{ $title := index $tab "title" }}
            {{ $content := index $tab "content" }}
            <button id="{{ $title }}" class="tablinks" data-tabset="{{ $id }}" onclick="changeTab(event, '{{ $id }}', '{{ $title }}')">{{ $title }}</button>
        {{ end }}
    {{ else }}
        <button id="defaultscript" class="tablinks" data-tabset="{{ $id }}" onclick="changeTab(event, '{{ $id }}', 'defaultscript')">Script</button>
    {{ end }}
</div>

<div class="tabcontent" data-tabset="{{ $id }}" id="iframedemo">
    <iframe 
        marginwidth="0"
        width="{{ $width }}" height="{{ $height }}" frameBorder="0"
        srcdoc="
            {{ $header }}
            <script>

            {{ if (.Scratch.Get "tabs") }}
                {{ range $tab := .Scratch.Get "tabs" }}
                    {{ replace (index $tab "content") "setup(" "oldSetup(" }}
                {{ end }}
            {{ else }}
                {{ replace .Inner "setup(" "oldSetup(" }}
            {{ end }}

            const START_PAUSED = {{ $startPaused }};

            {{ $additionalScript }}
            </script>
            {{ $footer }}
        "
    ></iframe>
</div>

{{ if (.Scratch.Get "tabs") }}
    {{ range $tab := .Scratch.Get "tabs" }}
        {{ $title := index $tab "title" }}
        {{ $content := index $tab "content" }}

        <div class="tabcontent" data-tabset="{{ $id }}" id="{{ $title }}">
        {{ (printf "```javascript\n%s\n```" $content) | markdownify }}
        </div>
    {{ end }}
{{ else }}
    <div class="tabcontent" data-tabset="{{ $id }}" id="defaultscript">
    {{ (printf "```javascript\n%s\n```" .Inner) | markdownify }}
    </div>
{{ end }}